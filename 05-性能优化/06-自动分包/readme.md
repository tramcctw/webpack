# 自动分包

## 基本原理

自动分包是一个更加宏观的角度，而一般不对具体哪个包要分出去进行控制

要控制自动分包，关键是要配置一个合理的**分包策略**

![](./assets/2020-02-24-17-19-47.png)

- 分包策略至关重要，它决定如何分包
- 分包时，webpack 开启一个新的 chunk，对分离的模块进行打包
- 打包结果中，公共的部分被提取出来形成一个单独的文件，它是新 chunk 的产物

## 分包策略的基本配置

optimization 配置项用于配置一些优化信息

```js
module.exports = {
  optimization: {
    splitChunks: {
      //分包策略
    },
  },
};
```

## 分包策略基本配置(全局配置)

- chunks 该配置用于配置需要应用分包策略的 chunk
  - all 对所有 chunk 都要应用分包策略
  - async 【默认】仅针对异步 chunk 应用分包策略
  - initial 仅针对普通 chunk 应用分包策略
- maxSize 控制包的 最大的字节数，超过会继续划分,分包的基本单位是模块，模块不会再被分割

## 其他配置(全局配置)

- automaticNameDelimiter 控制公共 chunk 的分割符默认为~
- minChunks: 一个模块被多少 chunk 引用才会分包，默认为 1
- minSize: 当分包达到多少字节后，才允许被真正的拆分，默认值为 30000

## 缓存组

之前的配置是全局的
而实际上分包策略是基于缓存组的
每个缓存组提供一套独有的策略，webpack 按照缓存组的优先级依次处理每个缓存组，被缓存组处理过的分包不需要再次分包,

```js
cacheGroups:{
  vendors:{
      // 当匹配到相应的模块时，将这些模块进行单独打包
      test:/[\\/]node_modules[\\/]/,
      // 缓存组的优先级，优先级越高，该策略越先进行处理默认为0
      priority:-10
  },
  default:{
      minChunks:2, // 覆盖全局配置，将最小chunk引用数改为2
      // 优先级
      priority:-20,
      // 重用已经被分离出去的chunk
      reuseExistingChunk:true
  }
}
```

**注意**
按优先级去分包，如果 default 的优先级大于 vendors 则所有符合条件的公共模块
使用 default 去分包，且在一个文件中，否则一个缓存组的配置对应一个分包

## 配合多页面应用

当有多个 html 页面时，
此时 html 页面会将所有的 chunk，css 文件全部引用

## 原理

1. 检查每个 chunk 的编译结果
2. 根据分包策略，找到那些满足策略的模块
3. 根据分包策略，生成新的 chunk 打包这些模块
4. 把打包出去的模块从原始包中移除，并修正原始包代码

代码层面的变动

1. 分包代码中加入全局变量webpackJsonp，类型为数组，其中包含公共模块的代码
2. 原始包的代码中，使用数组中的公共代码
